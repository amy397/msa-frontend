# MSA Shopping Mall Architecture Design

## 1. Domain Design (ERD) - 각 서비스별 테이블 구조

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                              USER-SERVICE (Port: 8081)                          │
├─────────────────────────────────────────────────────────────────────────────────┤
│  ┌─────────────────────────────────┐                                            │
│  │           users                 │                                            │
│  ├─────────────────────────────────┤                                            │
│  │ PK │ id          │ BIGINT       │                                            │
│  │    │ email       │ VARCHAR(50)  │ UNIQUE, NOT NULL                           │
│  │    │ password    │ VARCHAR(255) │ NOT NULL                                   │
│  │    │ name        │ VARCHAR(30)  │ NOT NULL                                   │
│  │    │ phone       │ VARCHAR(20)  │                                            │
│  │    │ role        │ ENUM         │ USER, ADMIN                                │
│  │    │ created_at  │ DATETIME     │                                            │
│  │    │ updated_at  │ DATETIME     │                                            │
│  └─────────────────────────────────┘                                            │
└─────────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────────┐
│                            PRODUCT-SERVICE (Port: 8082)                         │
├─────────────────────────────────────────────────────────────────────────────────┤
│  ┌─────────────────────────────────┐                                            │
│  │          products               │                                            │
│  ├─────────────────────────────────┤                                            │
│  │ PK │ id          │ BIGINT       │                                            │
│  │    │ name        │ VARCHAR(100) │ NOT NULL                                   │
│  │    │ description │ TEXT         │                                            │
│  │    │ price       │ DECIMAL      │ NOT NULL                                   │
│  │    │ stock       │ INT          │ NOT NULL                                   │
│  │    │ category    │ VARCHAR(50)  │                                            │
│  │    │ status      │ ENUM         │ AVAILABLE, OUT_OF_STOCK, DISCONTINUED      │
│  │    │ created_at  │ DATETIME     │                                            │
│  │    │ updated_at  │ DATETIME     │                                            │
│  └─────────────────────────────────┘                                            │
└─────────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────────┐
│                             ORDER-SERVICE (Port: 8083)                          │
├─────────────────────────────────────────────────────────────────────────────────┤
│  ┌─────────────────────────────────┐      ┌─────────────────────────────────┐   │
│  │           orders                │      │        order_items              │   │
│  ├─────────────────────────────────┤      ├─────────────────────────────────┤   │
│  │ PK │ id          │ BIGINT       │      │ PK │ id          │ BIGINT       │   │
│  │ FK │ user_id     │ BIGINT       │◄────►│ FK │ order_id    │ BIGINT       │   │
│  │    │ email       │ VARCHAR(100) │      │    │ product_id  │ BIGINT       │   │
│  │    │ total_price │ DECIMAL      │      │    │ product_name│ VARCHAR(100) │   │
│  │    │ status      │ ENUM         │      │    │ price       │ DECIMAL      │   │
│  │    │ created_at  │ DATETIME     │      │    │ quantity    │ INT          │   │
│  │    │ updated_at  │ DATETIME     │      └─────────────────────────────────┘   │
│  └─────────────────────────────────┘                                            │
│                                                                                 │
│  OrderStatus: PENDING, CONFIRMED, SHIPPING, DELIVERED, CANCELLED               │
└─────────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────────┐
│                            PAYMENT-SERVICE (Port: 8084)                         │
├─────────────────────────────────────────────────────────────────────────────────┤
│  ┌─────────────────────────────────┐                                            │
│  │          payments               │                                            │
│  ├─────────────────────────────────┤                                            │
│  │ PK │ id          │ BIGINT       │                                            │
│  │ FK │ order_id    │ BIGINT       │                                            │
│  │    │ amount      │ DECIMAL      │ NOT NULL                                   │
│  │    │ method      │ ENUM         │ CARD, BANK_TRANSFER                        │
│  │    │ status      │ ENUM         │ PENDING, COMPLETED, FAILED, REFUNDED       │
│  │    │ payment_key │ VARCHAR(100) │                                            │
│  │    │ created_at  │ DATETIME     │                                            │
│  └─────────────────────────────────┘                                            │
└─────────────────────────────────────────────────────────────────────────────────┘
```

### Entity Relationship Diagram (논리적 관계)

```
                    ┌──────────────┐
                    │    Users     │
                    │  (user-svc)  │
                    └──────┬───────┘
                           │ 1:N (user_id로 참조)
                           │
                    ┌──────▼───────┐         ┌──────────────┐
                    │    Orders    │────────►│   Payments   │
                    │ (order-svc)  │   1:1   │ (payment-svc)│
                    └──────┬───────┘         └──────────────┘
                           │ 1:N
                           │
                    ┌──────▼───────┐         ┌──────────────┐
                    │  OrderItems  │────────►│   Products   │
                    │ (order-svc)  │   N:1   │(product-svc) │
                    └──────────────┘         └──────────────┘
```

---

## 2. K8s Deployment Architecture - 온프레미스 클러스터 구성

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                        Kubernetes On-Premise Cluster                            │
│                                                                                 │
│  ┌───────────────────────────────────────────────────────────────────────────┐  │
│  │                           Master Node (Control Plane)                     │  │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌─────────────────┐   │  │
│  │  │ API Server  │  │  Scheduler  │  │ Controller  │  │      etcd       │   │  │
│  │  │             │  │             │  │   Manager   │  │  (Key-Value DB) │   │  │
│  │  └─────────────┘  └─────────────┘  └─────────────┘  └─────────────────┘   │  │
│  └───────────────────────────────────────────────────────────────────────────┘  │
│                                                                                 │
│  ┌───────────────────────────────────────────────────────────────────────────┐  │
│  │                              Worker Node 1                                │  │
│  │  ┌─────────────────────────────────────────────────────────────────────┐  │  │
│  │  │                        Namespace: msa-shop                          │  │  │
│  │  │  ┌──────────────────┐  ┌──────────────────┐  ┌──────────────────┐   │  │  │
│  │  │  │   Pod: Gateway   │  │  Pod: User-Svc   │  │ Pod: Product-Svc │   │  │  │
│  │  │  │   (Replicas: 2)  │  │   (Replicas: 2)  │  │   (Replicas: 2)  │   │  │  │
│  │  │  │   Port: 9090     │  │   Port: 8081     │  │   Port: 8082     │   │  │  │
│  │  │  └──────────────────┘  └──────────────────┘  └──────────────────┘   │  │  │
│  │  └─────────────────────────────────────────────────────────────────────┘  │  │
│  └───────────────────────────────────────────────────────────────────────────┘  │
│                                                                                 │
│  ┌───────────────────────────────────────────────────────────────────────────┐  │
│  │                              Worker Node 2                                │  │
│  │  ┌─────────────────────────────────────────────────────────────────────┐  │  │
│  │  │                        Namespace: msa-shop                          │  │  │
│  │  │  ┌──────────────────┐  ┌──────────────────┐  ┌──────────────────┐   │  │  │
│  │  │  │  Pod: Order-Svc  │  │ Pod: Payment-Svc │  │  Pod: Frontend   │   │  │  │
│  │  │  │   (Replicas: 2)  │  │   (Replicas: 2)  │  │   (Replicas: 2)  │   │  │  │
│  │  │  │   Port: 8083     │  │   Port: 8084     │  │   Port: 3000     │   │  │  │
│  │  │  └──────────────────┘  └──────────────────┘  └──────────────────┘   │  │  │
│  │  └─────────────────────────────────────────────────────────────────────┘  │  │
│  └───────────────────────────────────────────────────────────────────────────┘  │
│                                                                                 │
│  ┌───────────────────────────────────────────────────────────────────────────┐  │
│  │                              Worker Node 3                                │  │
│  │  ┌─────────────────────────────────────────────────────────────────────┐  │  │
│  │  │                        Namespace: database                          │  │  │
│  │  │  ┌──────────────────┐  ┌──────────────────┐  ┌──────────────────┐   │  │  │
│  │  │  │  Pod: MySQL-User │  │ Pod: MySQL-Order │  │Pod: MySQL-Product│   │  │  │
│  │  │  │   (StatefulSet)  │  │   (StatefulSet)  │  │   (StatefulSet)  │   │  │  │
│  │  │  │   Port: 3306     │  │   Port: 3307     │  │   Port: 3308     │   │  │  │
│  │  │  │      + PVC       │  │      + PVC       │  │      + PVC       │   │  │  │
│  │  │  └──────────────────┘  └──────────────────┘  └──────────────────┘   │  │  │
│  │  └─────────────────────────────────────────────────────────────────────┘  │  │
│  └───────────────────────────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────────────────────────┘
```

### K8s Resources 구성

```yaml
# Deployment 예시
┌─────────────────────────────────────────────────────────────────┐
│ Service Type        │ Replicas │ Resource Limits                │
├─────────────────────┼──────────┼────────────────────────────────┤
│ gateway-service     │    2     │ CPU: 500m, Memory: 512Mi       │
│ user-service        │    2     │ CPU: 500m, Memory: 512Mi       │
│ product-service     │    2     │ CPU: 500m, Memory: 512Mi       │
│ order-service       │    2     │ CPU: 500m, Memory: 512Mi       │
│ payment-service     │    2     │ CPU: 500m, Memory: 512Mi       │
│ frontend            │    2     │ CPU: 200m, Memory: 256Mi       │
│ mysql (StatefulSet) │    1     │ CPU: 1000m, Memory: 1Gi        │
└─────────────────────┴──────────┴────────────────────────────────┘
```

---

## 3. Service Communication Flow - 주문/결제 플로우

### 3.1 주문 생성 플로우

```
┌──────────┐     ┌──────────┐     ┌──────────┐     ┌──────────┐     ┌──────────┐
│  Client  │     │ Gateway  │     │  Order   │     │   User   │     │ Product  │
│(Frontend)│     │ Service  │     │ Service  │     │ Service  │     │ Service  │
└────┬─────┘     └────┬─────┘     └────┬─────┘     └────┬─────┘     └────┬─────┘
     │                │                │                │                │
     │ 1. POST /api/orders             │                │                │
     │ {userId, email, items}          │                │                │
     │───────────────►│                │                │                │
     │                │                │                │                │
     │                │ 2. Route to    │                │                │
     │                │    Order-Svc   │                │                │
     │                │───────────────►│                │                │
     │                │                │                │                │
     │                │                │ 3. Verify User │                │
     │                │                │───────────────►│                │
     │                │                │                │                │
     │                │                │◄───────────────│                │
     │                │                │  User Found    │                │
     │                │                │                │                │
     │                │                │ 4. Get Product │                │
     │                │                │    & Decrease  │                │
     │                │                │    Stock       │                │
     │                │                │───────────────────────────────►│
     │                │                │                │                │
     │                │                │◄───────────────────────────────│
     │                │                │  Product Info  │                │
     │                │                │                │                │
     │                │◄───────────────│                │                │
     │                │  Order Created │                │                │
     │◄───────────────│                │                │                │
     │  OrderResponse │                │                │                │
     │                │                │                │                │
```

### 3.2 결제 플로우 (카드 결제 - Toss Payments)

```
┌──────────┐     ┌──────────┐     ┌──────────┐     ┌──────────┐     ┌──────────┐
│  Client  │     │   Toss   │     │ Gateway  │     │ Payment  │     │  Order   │
│(Frontend)│     │ Payments │     │ Service  │     │ Service  │     │ Service  │
└────┬─────┘     └────┬─────┘     └────┬─────┘     └────┬─────┘     └────┬─────┘
     │                │                │                │                │
     │ 1. 결제창 호출  │                │                │                │
     │   (Client SDK) │                │                │                │
     │───────────────►│                │                │                │
     │                │                │                │                │
     │◄───────────────│                │                │                │
     │ 2. 결제 승인   │                │                │                │
     │    결과 반환   │                │                │                │
     │    (paymentKey)│                │                │                │
     │                │                │                │                │
     │ 3. 결제 확인 요청                │                │                │
     │ POST /api/payments/confirm      │                │                │
     │───────────────────────────────►│                │                │
     │                │                │                │                │
     │                │                │───────────────►│                │
     │                │                │                │                │
     │                │                │                │ 4. Toss API    │
     │                │◄───────────────────────────────│    결제 승인   │
     │                │                │                │                │
     │                │───────────────────────────────►│                │
     │                │                │                │ Payment OK     │
     │                │                │                │                │
     │                │                │                │ 5. Update      │
     │                │                │                │    Order Status│
     │                │                │                │───────────────►│
     │                │                │                │                │
     │                │                │                │◄───────────────│
     │                │                │◄───────────────│   CONFIRMED    │
     │◄───────────────────────────────│  Payment Done  │                │
     │   결제 완료     │                │                │                │
```

### 3.3 무통장입금 플로우

```
┌──────────┐     ┌──────────┐     ┌──────────┐     ┌──────────┐
│  Client  │     │ Gateway  │     │  Order   │     │  Admin   │
│(Frontend)│     │ Service  │     │ Service  │     │(Frontend)│
└────┬─────┘     └────┬─────┘     └────┬─────┘     └────┬─────┘
     │                │                │                │
     │ 1. 주문 생성 (무통장입금)        │                │
     │ POST /api/orders               │                │
     │ {status: PENDING}              │                │
     │───────────────►│───────────────►│                │
     │                │                │                │
     │◄───────────────│◄───────────────│                │
     │ 계좌 정보 표시  │   Order Created│                │
     │                │  (PENDING)     │                │
     │                │                │                │
     │                │                │                │ 2. 관리자가
     │                │                │                │    입금 확인
     │                │                │                │
     │                │                │ 3. 상태 변경   │
     │                │                │◄───────────────│
     │                │                │ PATCH /status  │
     │                │                │ ?status=CONFIRMED
     │                │                │                │
     │                │                │───────────────►│
     │                │                │   Updated      │
```

---

## 4. Network Configuration - K8s 네트워크 설계

### 4.1 Overall Network Architecture

```
                              ┌─────────────────────────────────────┐
                              │           External Network          │
                              │         (Internet / Users)          │
                              └──────────────────┬──────────────────┘
                                                 │
                                                 │ HTTPS (443)
                                                 ▼
┌────────────────────────────────────────────────────────────────────────────────┐
│                                  Ingress Controller                            │
│                               (NGINX / Traefik)                                │
│                                                                                │
│   ┌─────────────────────────────────────────────────────────────────────────┐  │
│   │  Rules:                                                                 │  │
│   │  - shop.example.com        → frontend-service:3000                      │  │
│   │  - api.shop.example.com    → gateway-service:9090                       │  │
│   │  - admin.shop.example.com  → frontend-service:3000 (admin routes)       │  │
│   └─────────────────────────────────────────────────────────────────────────┘  │
└────────────────────────────────────────────────────────────────────────────────┘
                                                 │
                                                 ▼
┌────────────────────────────────────────────────────────────────────────────────┐
│                            Kubernetes Cluster Network                          │
│                              (Pod Network: Calico)                             │
│                             CIDR: 10.244.0.0/16                                │
│                                                                                │
│  ┌──────────────────────────────────────────────────────────────────────────┐  │
│  │                      Namespace: msa-shop                                 │  │
│  │                      Service CIDR: 10.96.0.0/12                          │  │
│  │                                                                          │  │
│  │   ┌─────────────────────────────────────────────────────────────────┐    │  │
│  │   │                    ClusterIP Services                           │    │  │
│  │   │                                                                 │    │  │
│  │   │  ┌───────────────┐  ┌───────────────┐  ┌───────────────┐        │    │  │
│  │   │  │ gateway-svc   │  │  user-svc     │  │ product-svc   │        │    │  │
│  │   │  │ 10.96.1.1:9090│  │10.96.1.2:8081 │  │10.96.1.3:8082 │        │    │  │
│  │   │  └───────┬───────┘  └───────┬───────┘  └───────┬───────┘        │    │  │
│  │   │          │                  │                  │                │    │  │
│  │   │  ┌───────────────┐  ┌───────────────┐  ┌───────────────┐        │    │  │
│  │   │  │  order-svc    │  │ payment-svc   │  │ frontend-svc  │        │    │  │
│  │   │  │10.96.1.4:8083 │  │10.96.1.5:8084 │  │10.96.1.6:3000 │        │    │  │
│  │   │  └───────────────┘  └───────────────┘  └───────────────┘        │    │  │
│  │   └─────────────────────────────────────────────────────────────────┘    │  │
│  │                                                                          │  │
│  │   Service Discovery: Kubernetes DNS (CoreDNS)                            │  │
│  │   - gateway-svc.msa-shop.svc.cluster.local                               │  │
│  │   - user-svc.msa-shop.svc.cluster.local                                  │  │
│  │   - product-svc.msa-shop.svc.cluster.local                               │  │
│  │   - order-svc.msa-shop.svc.cluster.local                                 │  │
│  │   - payment-svc.msa-shop.svc.cluster.local                               │  │
│  └──────────────────────────────────────────────────────────────────────────┘  │
│                                                                                │
│  ┌──────────────────────────────────────────────────────────────────────────┐  │
│  │                      Namespace: database                                 │  │
│  │                                                                          │  │
│  │   ┌─────────────────────────────────────────────────────────────────┐    │  │
│  │   │                    Headless Services                            │    │  │
│  │   │                                                                 │    │  │
│  │   │  ┌───────────────┐  ┌───────────────┐  ┌───────────────┐        │    │  │
│  │   │  │ mysql-user    │  │ mysql-order   │  │mysql-product  │        │    │  │
│  │   │  │  :3306        │  │   :3306       │  │   :3306       │        │    │  │
│  │   │  │ (StatefulSet) │  │ (StatefulSet) │  │ (StatefulSet) │        │    │  │
│  │   │  └───────────────┘  └───────────────┘  └───────────────┘        │    │  │
│  │   └─────────────────────────────────────────────────────────────────┘    │  │
│  │                                                                          │  │
│  │   PersistentVolume: NFS / Local Storage                                  │  │
│  └──────────────────────────────────────────────────────────────────────────┘  │
└────────────────────────────────────────────────────────────────────────────────┘
```

### 4.2 Network Policies (네트워크 보안)

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                            Network Policies                                     │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                 │
│  ┌─────────────────────────────────────────────────────────────────────────┐    │
│  │ Policy: allow-frontend-to-gateway                                       │    │
│  │ From: frontend pods                                                     │    │
│  │ To: gateway-service (Port 9090)                                         │    │
│  └─────────────────────────────────────────────────────────────────────────┘    │
│                                                                                 │
│  ┌─────────────────────────────────────────────────────────────────────────┐    │
│  │ Policy: allow-gateway-to-services                                       │    │
│  │ From: gateway-service pods                                              │    │
│  │ To: user-svc, product-svc, order-svc, payment-svc                       │    │
│  └─────────────────────────────────────────────────────────────────────────┘    │
│                                                                                 │
│  ┌─────────────────────────────────────────────────────────────────────────┐    │
│  │ Policy: allow-services-to-database                                      │    │
│  │ From: user-svc, product-svc, order-svc                                  │    │
│  │ To: mysql pods (Port 3306)                                              │    │
│  └─────────────────────────────────────────────────────────────────────────┘    │
│                                                                                 │
│  ┌─────────────────────────────────────────────────────────────────────────┐    │
│  │ Policy: allow-order-to-other-services                                   │    │
│  │ From: order-service pods                                                │    │
│  │ To: user-svc (Port 8081), product-svc (Port 8082)                       │    │
│  └─────────────────────────────────────────────────────────────────────────┘    │
│                                                                                 │
│  ┌─────────────────────────────────────────────────────────────────────────┐    │
│  │ Policy: deny-all-ingress (Default)                                      │    │
│  │ Deny all incoming traffic except explicitly allowed                     │    │
│  └─────────────────────────────────────────────────────────────────────────┘    │
│                                                                                 │
└─────────────────────────────────────────────────────────────────────────────────┘
```

### 4.3 Port Summary

```
┌─────────────────────────────────────────────────────────────────┐
│                      Service Port Mapping                       │
├─────────────────────┬──────────────┬────────────────────────────┤
│      Service        │     Port     │        Description         │
├─────────────────────┼──────────────┼────────────────────────────┤
│ Frontend (React)    │     3000     │ Web Application            │
│ Gateway Service     │     9090     │ API Gateway                │
│ User Service        │     8081     │ User Management            │
│ Product Service     │     8082     │ Product Catalog            │
│ Order Service       │     8083     │ Order Processing           │
│ Payment Service     │     8084     │ Payment Processing         │
│ MySQL               │     3306     │ Database                   │
│ Ingress (HTTP)      │       80     │ External HTTP              │
│ Ingress (HTTPS)     │      443     │ External HTTPS             │
└─────────────────────┴──────────────┴────────────────────────────┘
```

---

## Summary

| 구분 | 기술 스택 |
|------|----------|
| Frontend | React 18, Tailwind CSS, Zustand |
| Backend | Spring Boot 3.x, Spring Cloud Gateway |
| Database | MySQL 8.x (서비스별 분리) |
| Container | Docker, Kubernetes |
| Ingress | NGINX Ingress Controller |
| Network | Calico CNI |
| Storage | NFS / Local Persistent Volume |
| Payment | Toss Payments API |

---

*Generated: 2025-12-19*
